{% extends "maposmatic/base.html" %}

{% comment %}
 coding: utf-8

 maposmatic, the web front-end of the MapOSMatic city map generation system
 Copyright (C) 2009  David Decotigny
 Copyright (C) 2009  Frédéric Lehobey
 Copyright (C) 2009  David Mentré
 Copyright (C) 2009  Maxime Petazzoni
 Copyright (C) 2009  Thomas Petazzoni
 Copyright (C) 2009  Gaël Utard

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU Affero General Public License as
 published by the Free Software Foundation, either version 3 of the
 License, or any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU Affero General Public License for more details.

 You should have received a copy of the GNU Affero General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}
{% load i18n %}

{% block extralink %}
<script type="text/javascript" src="/smedia/jquery.js"></script>
{{ form.media }}
{% endblock %}

{% block extrajs %}
String.prototype.startsWith = function(str) { return this.indexOf(str) === 0; }

function area_selection_mode_switch(mode)
{
  var arr = document.getElementById('mapform').getElementsByTagName('tr');
  for (i=0; i < arr.length; i++) {
    if (arr[i].className.startsWith('byadmin')) {
      arr[i].style.display = 'none';
      if (mode == 'admin-mode')
        arr[i].style.display = 'table-row';
    }
    if (arr[i].className.startsWith('bybbox')) {
      arr[i].style.display = 'none';
      if (mode == 'bbox-mode')
        arr[i].style.display = 'table-row';
    }
  }

  if (mode == 'bbox-mode') {
    reset_osmid_field();
    if (map == null) init();
  }
}

function reset_osmid_field()
{
    document.getElementById("id_administrative_osmid").value = "";
}

function pageinit()
{
  document.getElementById('id_mode_0').setAttribute('onclick',
    "area_selection_mode_switch('admin-mode')");
  document.getElementById('id_mode_1').setAttribute('onclick',
    "area_selection_mode_switch('bbox-mode')");

  if (document.getElementById('id_mode_1').checked)
    area_selection_mode_switch('bbox-mode');
  else
    area_selection_mode_switch('admin-mode');

  document.getElementById('id_administrative_city').setAttribute('onchange','reset_osmid_field()');
}

var elemFound = 0 ;

function toggle_form_validation(enableForm)
{

  if (enableForm == "true")
    {
       $("#id-go-next-btn").attr("disabled", "false");
       $("#id-go-next-btn").attr("src", "/smedia/Go-next.png");
    }
  else
    {
       $("#id-go-next-btn").attr("disabled", "true");
       $("#id-go-next-btn").attr("src", "/smedia/Go-next-disabled.png");
    }
}

function validate_city_search()
{
  $("#result_nominatim_search").empty();
  $("#result_nominatim_search").append("<li><img src=\"/smedia/loading.gif\" alt=\"Loading\" /></li>");

  var searchPat = document.getElementById("id_administrative_city").value ;

  elemFound = 0;

  $.getJSON("/nominatim/" + searchPat,
            function(data){
              $("#result_nominatim_search").empty();


              $.each(data, function(i,item){
		if (typeof item.ocitysmap_params == "undefined")
		{
		  $("#result_nominatim_search").append("<li><img src=\"/smedia/icon_alert.png\" "+
		    "alt=\"Work In Progress\" />&nbsp;<label class=\"place_unavailable\""
		    + ">" +item.display_name + "</label></li>");
                }
		else
                {
                  $("#result_nominatim_search").append("<li><input onchange=\"javascript:update_hidden(this,'"
		     +item.display_name+"');\" type=\"radio\" name=\"administrative_tmp_osmid\" value=\""
		     +item.ocitysmap_params['id']+"\" id=\"rd"+item.ocitysmap_params['id']+"\"/><label for=\"rd"+
		     item.ocitysmap_params['id']+"\">"
		     +item.display_name+"</label></li>");
		  elemFound = elemFound + 1;
                }
	      });

	      if (elemFound == 0)
              {
	 	 toggle_form_validation("false");
	         $("#result_nominatim_search").empty();
                 $("#result_nominatim_search").append("<li><b>{% trans 'No results found.' %}</b></li>");
              }
	    });
}

function update_hidden(obj, nloc)
{
  toggle_form_validation("true");

  document.getElementById("id_administrative_osmid").value = obj.value;
  document.getElementById("id_administrative_city").value = nloc;
}

{% endblock %}

{% block menu-home %}
class="activelink"
{% endblock %}

{% block extrabody %}
onload='pageinit()'
{% endblock %}

{% block page %}
<h1>MapOSMatic</h1>

<h2>{% trans "Introduction" %}</h2>

<div style="float: right; margin-left: 3em;">
  <table style="text-align: center">
    <tr>
      <td><a href="/smedia/chavagne.png"><img style="width: 200px;" src="/smedia/chavagne-small.png"></td></a>
      <td><a href="/smedia/chavagne_index.png"><img style="width: 200px;" src="/smedia/chavagne_index-small.png"></a></td>
    </tr>
    <tr>
      <td>
	{% trans "City Map" %}<br/>
	<a href="/smedia/chavagne.png">PNG</a>&nbsp;-&nbsp;
	<a href="/smedia/chavagne.pdf">PDF</a>&nbsp;-&nbsp;
	<a href="/smedia/chavagne.svg">SVG</a>
      </td>
      <td>
	{% trans "Streets index" %}<br/>
	<a href="/smedia/chavagne_index.png">PNG</a>&nbsp;-&nbsp;
	<a href="/smedia/chavagne_index.pdf">PDF</a>&nbsp;-&nbsp;
	<a href="/smedia/chavagne_index.svg">SVG</a>
      </td>
    </tr>
  </table>
</div>

<p>{% blocktrans %}MapOSMatic is a free software web service that
allows you to generate maps of cities using
<a href="http://www.openstreetmap.org">OpenStreetMap</a> data. A city map
is made of two pages:{% endblocktrans %}</p>

<ul>
  <li>{% blocktrans %}The map itself, splitted in squares allowing to easily look for streets;{% endblocktrans %}</li>
  <li>{% blocktrans %}An index of the streets with references to the squares on the map.{% endblocktrans %}</li>
</ul>

<p>{% blocktrans %}The generated maps are available in PNG, PDF and
SVG formats and are ready to be printed.{% endblocktrans %}</p>

<p>{% blocktrans %}As the data used to generate maps is coming from
OpenStreetMap, you can freely (under the <a
href="http://wiki.openstreetmap.org/wiki/License">terms of
OpenStreetMap license</a>) reuse, sell, modify, ... the generated
maps.{% endblocktrans %}</p>

<p><a href="/about/">{% trans "More details" %} &raquo;</a></p>

<h2 style="clear: right"><a href="#submitmapform">{% trans "Generate your own map" %}</a></h2>

<a name="submitmapform"></a>
<form method="post" action="/#submitmapform" class="submitmap">

  <table id="mapform">
    <tr class="label">
      <td>{% trans "Area selection mode:" %}</td>
      <td rowspan="4" class="image">
        <input id="id-go-next-btn" type="image" src="/smedia/Go-next-disabled.png" value="{% trans "Generate" %}"
               title="{% trans "Generate" %}" />
      </td>
    </tr>
    <tr class="field">
      <td>
        {{ form.mode }}
      </td>
    </tr>

    <tr class="byadmin label"><td>{% trans "City name:" %}</td></tr>
    <tr class="byadmin field"><td>
        {{ form.administrative_city }}
	<input type="button" onclick="javascript:validate_city_search();" value="{% trans "search" %}" />
	{{ form.administrative_osmid }}
	{{ form.administrative_osmid.errors }}
        {{ form.administrative_city.errors }}
    </td></tr>

    <tr class="bybbox label"><td>{% trans "Title of the map:" %}</td></tr>
    <tr class="bybbox field"><td>
        {{ form.maptitle }}
        {{ form.maptitle.errors }}
    </td></tr>

    <tr class="bybbox label"><td colspan="2">{% trans "Bounding box:" %}</td></tr>
    <tr class="bybbox field"><td colspan="2" style="text-align: center;">
        {{ form.bbox }}
        {{ form.bbox.errors }}
    </td></tr>
    <tr class="byadmin field">
      <td colspan="2">
	<ul id="result_nominatim_search">
	</ul>
      </td>
    </tr>
    <tr class="label">
      <td>{% trans "Map Index Language:" %}</td>
    </tr>
    <tr class="field">
      <td>
	{{ form.map_language }}
      </td>
    </tr>
  </table>
</form>

  <p>{%blocktrans%}Right now <em>MapOSMatic</em> is only available for the
metropolitan France area. We need contributors to translate and adapt
the few parts of <em>MapOSMatic</em> that are country
specific.{%endblocktrans%}</p>

<p>{%blocktrans%}To select the city to be rendered, two modes are
available:{%endblocktrans%}</p>

<ul>

  <li>{%blocktrans%}Using an administrative boundary. It allows to get a
  map with precise boundaries of the city, but they are for the moment
  only available for part of the metropolitan French cities (about a
  third). The name of the provided city must <em>exactly match</em> the
  one available in the OpenStreetMap database (no case or accent
  difference is allowed). Working examples
  are: <code>Chavagne</code>, <code>Bénodet</code> or
  <code>Sanguinet</code>.{%endblocktrans%}</li>

  <li>{%blocktrans%}Using a traditional bounding
  box.{%endblocktrans%}</li>

</ul>

<p>{%blocktrans%}Once the rendering is submitted, you will be brought
to a page giving the status of your rendering request. As soon as the
rendering is completed (that might take some time depending on the queue
length), this page will contain links to the generated
map.{%endblocktrans%}</p>

{% endblock %}
